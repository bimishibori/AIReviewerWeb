<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" th:replace="layout :: base(title='レビュー履歴', content=~{::content})">
<div th:fragment="content">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-history me-2 text-primary"></i>
                    レビュー履歴
                    <span th:if="${repository}" class="text-muted">
                        - <span th:text="${repository.name}"></span>
                    </span>
                </h1>
                <div class="btn-group" role="group">
                    <a href="/repositories" class="btn btn-outline-secondary">
                        <i class="fas fa-folder me-2"></i>リポジトリ一覧
                    </a>
                    <a th:if="${repository}" th:href="@{/reviews/execute(repositoryId=${repository.id})}" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>新しいレビュー実行
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- フィルター -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" action="/reviews/history" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">リポジトリ</label>
                            <select class="form-select" name="repositoryId">
                                <option value="">すべて</option>
                                <!-- TODO: リポジトリ一覧をコントローラーから渡す -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ステータス</label>
                            <select class="form-select" name="status">
                                <option value="">すべて</option>
                                <option value="COMPLETED">完了</option>
                                <option value="FAILED">失敗</option>
                                <option value="RUNNING">実行中</option>
                                <option value="PENDING">待機中</option>
                                <option value="CANCELLED">キャンセル</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>検索
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 履歴一覧 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>実行履歴
                        <span class="badge bg-secondary ms-2" th:text="${histories.totalElements}"></span>
                    </h6>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(histories.content)}" class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">レビュー履歴がありません。</p>
                        <a href="/repositories" class="btn btn-primary">
                            <i class="fas fa-folder me-2"></i>リポジトリ一覧へ
                        </a>
                    </div>

                    <div th:if="${!#lists.isEmpty(histories.content)}">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 20%">リポジトリ</th>
                                    <th style="width: 15%">開始日時</th>
                                    <th style="width: 15%">完了日時</th>
                                    <th style="width: 10%">実行時間</th>
                                    <th style="width: 10%">ステータス</th>
                                    <th style="width: 10%">問題数</th>
                                    <th style="width: 20%" class="text-end">アクション</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="history : ${histories.content}">
                                    <td>
                                        <h6 class="mb-1" th:text="${history.repositoryName}"></h6>
                                        <small class="text-muted" th:if="${history.commitHash}" th:text="${history.commitHash}"></small>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(history.startedAt, 'yyyy/MM/dd')}"></span>
                                        <br>
                                        <small class="text-muted" th:text="${#temporals.format(history.startedAt, 'HH:mm:ss')}"></small>
                                    </td>
                                    <td>
                                        <div th:if="${history.completedAt}">
                                            <span th:text="${#temporals.format(history.completedAt, 'yyyy/MM/dd')}"></span>
                                            <br>
                                            <small class="text-muted" th:text="${#temporals.format(history.completedAt, 'HH:mm:ss')}"></small>
                                        </div>
                                        <div th:unless="${history.completedAt}">
                                            <span class="text-muted">-</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span th:if="${history.duration}" th:text="${history.duration}"></span>
                                        <span th:unless="${history.duration}" class="text-muted">-</span>
                                    </td>
                                    <td>
                                            <span th:class="'badge ' + (${history.status.name()} == 'COMPLETED' ? 'bg-success' :
                                                          ${history.status.name()} == 'FAILED' ? 'bg-danger' :
                                                          ${history.status.name()} == 'RUNNING' ? 'bg-primary' :
                                                          ${history.status.name()} == 'CANCELLED' ? 'bg-secondary' : 'bg-warning')"
                                                  th:text="${history.status.name() == 'COMPLETED' ? '完了' :
                                                           history.status.name() == 'FAILED' ? '失敗' :
                                                           history.status.name() == 'RUNNING' ? '実行中' :
                                                           history.status.name() == 'PENDING' ? '待機中' : 'キャンセル'}"></span>
                                    </td>
                                    <td>
                                            <span th:if="${history.totalIssues != null and history.totalIssues > 0}"
                                                  class="badge bg-warning text-dark" th:text="${history.totalIssues}"></span>
                                        <span th:unless="${history.totalIssues != null and history.totalIssues > 0}"
                                              class="text-muted">-</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a th:if="${history.status.name() == 'COMPLETED'}"
                                               th:href="@{/reviews/{id}/results(id=${history.id})}"
                                               class="btn btn-outline-primary" title="結果表示">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a th:if="${history.status.name() == 'RUNNING'}"
                                               th:href="@{/reviews/{id}/progress(id=${history.id})}"
                                               class="btn btn-outline-info" title="進行状況">
                                                <i class="fas fa-cogs"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-secondary"
                                                    title="詳細" th:onclick="|showDetails(${history.id})|">
                                                <i class="fas fa-info"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- ページネーション -->
                        <nav th:if="${histories.totalPages > 1}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${!histories.hasPrevious} ? 'disabled'">
                                    <a class="page-link" th:href="@{/reviews/history(page=${currentPage - 1}, repositoryId=${repositoryId})}">前へ</a>
                                </li>
                                <li th:each="i : ${#numbers.sequence(0, histories.totalPages - 1)}"
                                    class="page-item" th:classappend="${i == currentPage} ? 'active'">
                                    <a class="page-link" th:href="@{/reviews/history(page=${i}, repositoryId=${repositoryId})}" th:text="${i + 1}"></a>
                                </li>
                                <li class="page-item" th:classappend="${!histories.hasNext} ? 'disabled'">
                                    <a class="page-link" th:href="@{/reviews/history(page=${currentPage + 1}, repositoryId=${repositoryId})}">次へ</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細情報モーダル -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        レビュー詳細情報
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailContent">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">詳細情報を読み込み中...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showDetails(reviewId) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            const detailContent = document.getElementById('detailContent');

            // モーダル表示
            modal.show();

            // TODO: レビュー詳細情報を取得するAPI実装
            // 仮の詳細情報表示
            setTimeout(() => {
                detailContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本情報</h6>
                            <dl class="row">
                                <dt class="col-sm-4">レビューID</dt>
                                <dd class="col-sm-8">${reviewId}</dd>
                                <dt class="col-sm-4">対象ファイル数</dt>
                                <dd class="col-sm-8">123 ファイル</dd>
                                <dt class="col-sm-4">処理済みファイル</dt>
                                <dd class="col-sm-8">123 ファイル</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>エラー情報</h6>
                            <div class="alert alert-light">
                                エラーは発生していません
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>実行ログ</h6>
                        <div class="bg-dark text-light p-3 rounded" style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                            <div>[12:34:56] レビューを開始しました</div>
                            <div>[12:34:57] リポジトリをクローンしています...</div>
                            <div>[12:35:15] ファイルをスキャンしています...</div>
                            <div>[12:35:20] 123 ファイルが見つかりました</div>
                            <div>[12:37:45] レビューが完了しました</div>
                        </div>
                    </div>
                `;
            }, 500);
        }
    </script>
</div>
</html>